## Promise 基本用法

ES6 规定，Promise 对象是一个构造函数，用来生成 Promise 实例。

下面的代码创建了一个`Promise`实例：

```js
const promise = new Promise(function(resolve, reject) {
  // ... some code

  if (/* 异步操作成功 */){
    resolve(value);
  } else {
    reject(error);
  }
});
```

`Promise`构造函数接受一个函数作为参数，该函数的两个参数分别是`resolve`和`reject`。它们是两个函数，由 `JavaScript` 引擎提供，不用自己部署。

`resolve`函数的作用是:

将`Promise`对象的状态从“未完成”变为“成功”（即从 `pending `---> `resolved`），在异步操作成功时调用，并将异步操作的结果，作为参数传递出去；

`reject`函数的作用是:

将 Promise 对象的状态从“未完成”变为“失败”（即从 `pending` ---> `rejected`），在异步操作失败时调用，并将异步操作报出的错误，作为参数传递出去。

Promise 实例生成以后，可以用`then`方法分别指定`resolved`状态和`rejected`状态的回调函数。

```js
promise.then(
  function (value) {
    // success
  },
  function (error) {
    // failure
  }
);
```

`then`方法可以接受两个回调函数作为参数:

1. `Promise`对象的状态变为`resolved`时调用，
2. `Promise`对象的状态变为`rejected`时调用。

这两个函数都是可选的，不一定要提供。它们都接受`Promise`对象传出的值作为参数。

下面是一个`Promise`对象的简单例子。

```js
function timeout(ms) {
  return new Promise((resolve, reject) => {
    setTimeout(resolve, ms, "done");
  });
}

timeout(2000).then((value) => console.log(value)); // done
```

Promise 创建以后会先执行，下面的例子可以说明：

```js
// step 1
const promise = new Promise((resolve, reject) => {
  console.log("new Promise()");
  resolve();
});
// step 2
promise.then(() => {
  console.log("promise then");
});
// step 3
console.log("finished");

// new Promise()
// finished
// promise then
```

上面的代码中，`promise`创建的时候就会先执行，所以会打印`new Promise()`，`step 2`会在`Promise`状态变为`resolve`的时候才会执行，所以会暂时跳过，去执行`step 3`。

下面是一个异步加载图片的例子：

```js
function loadImageAsync(url) {
  return new Promise(function (resolve, reject) {
    const image = new Image();

    image.onload = function () {
      resolve(image);
    };

    image.onerror = function () {
      reject(new Error("Could not load image at " + url));
    };

    image.src = url;
  });
}

async function load() {
  const res = await loadImageAsync(
    "https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fimg1.efu.com.cn%2Fupfile%2Ftrade%2F2014-02-08%2F60bd633c-dd0a-491e-84ff-9bfe669fb16b.jpg&refer=http%3A%2F%2Fimg1.efu.com.cn&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=jpeg?sec=1631070021&t=c4e71d249d82faab252c39b96a75e4d4"
  );
  const bodys = document.querySelector("body");
  bodys.appendChild(res);
}

load();
```

注意，调用resolve或reject并不会终结 Promise 的参数函数的执行。
```js
new Promise((resolve, reject) => {
  resolve(1);
  console.log(2);
}).then(r => {
  console.log(r);
});
// 2
// 1
```
